@{
    ViewBag.Title = "BookingDetails";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Booking Details</h2>

<div class="card shadow mb-4">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered" id="bookingTable" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th>Booking ID</th>
                        <th>Customer</th>
                        <th>Car</th>
                        <th>Pickup Time</th>
                        <th>Pickup Location</th>
                        <th>Drop Location</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="bookingTableBody">
                    <!-- Rows injected dynamically -->
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet" />

    <script>
        $(document).ready(function () {
            $.ajax({
                url: '@Url.Action("GetBookingDetails", "BookingDetails")',
                type: 'GET',
                success: function (data) {
                    const result = JSON.parse(data);
                    if (result.error) {
                        console.error(result.error);
                        alert("Error loading booking data.");
                        return;
                    }

                    let html = "";

                    result.forEach(function (item) {
                        let statusCol = (item.c_assign_status == 1)
                            ? `<span class="badge bg-success">Assigned</span>`
                            : `<span class="badge bg-warning text-dark">Pending</span>`;

                        let actionCol = "";
                        if (item.c_assign_status == 1) {
                            actionCol = `<span class="text-success fw-bold"><i class="fas fa-user-check"></i> ${item.assigned_driver}</span>`;
                        } else {
                            actionCol = `<button class="btn btn-sm btn-primary" onclick="assignDriver('${item.bookingid}')">
                                            <i class="fas fa-user-plus"></i> Assign
                                         </button>`;
                        }

                        html += `<tr>
                            <td>${item.bookingid}</td>
                            <td>${item.customer}</td>
                            <td>${item.assigned_car}</td>
                            <td>${formatDateTime(item.pickuptime)}</td>
                            <td>${item.pickuploc}</td>
                            <td>${item.droploc}</td>
                            <td>${statusCol}</td>
                            <td>${actionCol}</td>
                        </tr>`;
                    });

                    $('#bookingTableBody').html(html);

                    // Initialize DataTable after rows are injected
                    $('#bookingTable').DataTable({
                        paging: true,
                        searching: true,
                        ordering: true,
                        responsive: true
                    });
                },
                error: function () {
                    alert("AJAX error loading booking details.");
                }
            });
        });

        function assignDriver(bookingId) {
            alert("Assign driver for Booking ID: " + bookingId);
            // Add modal logic here later
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);

            if (isNaN(date)) return '';

            const day = ('0' + date.getDate()).slice(-2);
            const month = ('0' + (date.getMonth() + 1)).slice(-2);
            const year = date.getFullYear();

            let hours = date.getHours();
            const minutes = ('0' + date.getMinutes()).slice(-2);
            const ampm = hours >= 12 ? 'PM' : 'AM';

            hours = hours % 12;
            hours = hours ? hours : 12; // 0 becomes 12

            const formattedTime = `${day}-${month}-${year} ${hours}:${minutes} ${ampm}`;
            return formattedTime;
        }

    </script>
}
